<main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">
    <div class="max-w-4xl mx-auto">
        <div class="space-y-12">
            
            <!-- Intro Section -->
            <section id="intro" class="text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900">Sessionize Web Analytics Funnel</h2>
                <p class="mt-4 text-lg text-gray-600 max-w-3xl mx-auto">Transform noisy page-view event streams into meaningful user sessions with start/end times, page counts, and conversion flags. Turn clickstream chaos into actionable insights.</p>
                <div class="pro-tip p-4 rounded-md my-6 max-w-2xl mx-auto">
                    <p><strong class="font-semibold text-yellow-800">Why This Matters:</strong> Raw analytics are just rows of events. Sessionization groups events into visits, letting you analyze conversion rates, drop-off points, and user journeys. This pattern applies to any time-series event data: logins, API calls, sensor readings.</p>
                </div>
                <div class="bg-green-50 border-l-4 border-green-500 p-4 my-6 max-w-2xl mx-auto">
                    <p class="text-left"><strong class="font-semibold text-green-800">What You'll Build:</strong> A session-level table with session_id, start/end timestamps, page count, conversion flag, and time-on-session metrics.</p>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 my-6 max-w-2xl mx-auto">
                    <p class="text-left"><strong class="font-semibold text-blue-800">Key Skills:</strong> Sessionization logic, rolling metrics, indexing, time calculations, group aggregations</p>
                </div>
            </section>

            <!-- Step 1 -->
            <section id="step1" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">1</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Load Web Analytics Events</h2>
                        <p class="mt-2 text-gray-700">Connect to your page view log or analytics export with timestamp, user ID, and page URL data.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Load your event data (Google Analytics export, server logs, or tracking database).</li>
                        <li>Ensure you have these columns:
                            <ul class="list-disc list-inside ml-6 mt-2">
                                <li><strong>Event_Timestamp</strong> (when the page view occurred)</li>
                                <li><strong>User_ID</strong> or Session_ID (to group events)</li>
                                <li><strong>Page_URL</strong> or Event_Type</li>
                                <li><strong>Event_ID</strong> (unique per event, optional)</li>
                            </ul>
                        </li>
                        <li>Set <strong class="font-semibold text-gray-800">Event_Timestamp</strong> to Date/Time type.</li>
                    </ul>
                    <div class="bg-white rounded border p-4 mt-4 max-w-2xl">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Sample Event Data:</p>
                        <table class="w-full text-xs">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left border">User_ID</th>
                                    <th class="p-2 text-left border">Event_Timestamp</th>
                                    <th class="p-2 text-left border">Page_URL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="p-2 border">user_123</td><td class="p-2 border">10/15 09:00:00</td><td class="p-2 border">/home</td></tr>
                                <tr><td class="p-2 border">user_123</td><td class="p-2 border">10/15 09:02:15</td><td class="p-2 border">/products</td></tr>
                                <tr><td class="p-2 border">user_123</td><td class="p-2 border">10/15 09:05:30</td><td class="p-2 border">/checkout</td></tr>
                                <tr><td class="p-2 border">user_123</td><td class="p-2 border">10/15 12:00:00</td><td class="p-2 border">/home</td></tr>
                            </tbody>
                        </table>
                        <p class="text-xs text-gray-500 mt-2 italic">Note the 3-hour gap—that's a new session!</p>
                    </div>
                    <div class="interactive-diagram p-4 rounded-lg mt-4">
                        <p class="text-center text-sm text-gray-500 mb-2">Interactive: Event Timeline Visualizer</p>
                        <div class="bg-white rounded-lg border border-gray-300 shadow-md w-full p-4">
                            <div class="mb-3 text-sm">
                                <label class="font-semibold text-gray-700">Session Timeout (minutes):</label>
                                <input id="d1-timeout" type="range" min="5" max="120" value="30" step="5" class="w-full mt-2">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>5 min</span>
                                    <span id="d1-timeout-value" class="font-semibold text-blue-600">30 min</span>
                                    <span>120 min</span>
                                </div>
                            </div>
                            <div id="d1-timeline" class="space-y-4 mt-4">
                                <!-- Timeline will be populated by JavaScript -->
                            </div>
                            <p id="d1-message" class="text-center mt-3 text-sm font-medium text-blue-600 h-5"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2 -->
            <section id="step2" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">2</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Sort by User and Timestamp</h2>
                        <p class="mt-2 text-gray-700">Sessionization requires events to be in chronological order for each user.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Click <strong class="font-semibold text-gray-800">Sort</strong> in the Home tab.</li>
                        <li>Sort by:
                            <ul class="list-disc list-inside ml-6 mt-2">
                                <li><strong>User_ID</strong> (ascending)</li>
                                <li>Then by <strong>Event_Timestamp</strong> (ascending)</li>
                            </ul>
                        </li>
                        <li>Now all events for each user are grouped together in time order.</li>
                    </ul>
                </div>
            </section>

            <!-- Step 3 -->
            <section id="step3" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">3</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Calculate Time Since Previous Event</h2>
                        <p class="mt-2 text-gray-700">Add a column showing the gap between this event and the previous one for the same user.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Add an <strong class="font-semibold text-gray-800">Index Column</strong> (starting at 0).</li>
                        <li>Add a custom column called <strong class="font-semibold text-gray-800">Previous_Timestamp</strong>:</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>let
    currentIndex = [Index],
    currentUser = [User_ID]
in
    if currentIndex = 0 then null
    else 
        let
            prevRow = Table.SelectRows(#"Added Index", each [Index] = currentIndex - 1){0},
            prevUser = prevRow[User_ID]
        in
            if currentUser = prevUser then prevRow[Event_Timestamp] else null</code></pre>
                    </div>
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl mt-4" start="3">
                        <li>Add another column for <strong class="font-semibold text-gray-800">Minutes_Since_Previous</strong>:</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>if [Previous_Timestamp] = null then null
else Duration.TotalMinutes([Event_Timestamp] - [Previous_Timestamp])</code></pre>
                    </div>
                </div>
            </section>

            <!-- Step 4 -->
            <section id="step4" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">4</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Flag Session Boundaries</h2>
                        <p class="mt-2 text-gray-700">Mark rows where a new session starts—either the first event for a user or after a timeout period (e.g., 30 minutes of inactivity).</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Define your session timeout (typically 30 minutes).</li>
                        <li>Add a custom column <strong class="font-semibold text-gray-800">Is_New_Session</strong>:</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>let
    timeout = 30  // minutes
in
    if [Minutes_Since_Previous] = null then 1  // First event
    else if [Minutes_Since_Previous] > timeout then 1  // New session after timeout
    else 0  // Same session</code></pre>
                    </div>
                    <div class="pro-tip p-4 rounded-md mt-4 max-w-3xl">
                        <p><strong class="font-semibold text-yellow-800">Session Timeout:</strong> 30 minutes is standard for web analytics. Adjust based on your use case (shorter for high-frequency apps, longer for research sites).</p>
                    </div>
                    <div class="interactive-diagram p-4 rounded-lg mt-4">
                        <p class="text-center text-sm text-gray-500 mb-2">Interactive: Session Grouping Demo</p>
                        <div class="bg-white rounded-lg border border-gray-300 shadow-md w-full p-4">
                            <div class="mb-3">
                                <button id="d2-group-btn" class="w-full px-4 py-2 text-sm rounded bg-blue-500 text-white hover:bg-blue-600 font-medium">Group Events into Sessions</button>
                            </div>
                            <div id="d2-events" class="space-y-2 text-xs">
                                <!-- Events will be displayed here -->
                            </div>
                            <div id="d2-sessions" class="mt-4 space-y-3 hidden">
                                <!-- Sessions will be displayed here -->
                            </div>
                            <p id="d2-message" class="text-center mt-3 text-sm font-medium h-5"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 5 -->
            <section id="step5" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">5</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Create Session IDs</h2>
                        <p class="mt-2 text-gray-700">Generate a unique session ID by doing a cumulative sum of the session boundary flags.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Add a custom column <strong class="font-semibold text-gray-800">Session_ID</strong> using a running total:</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>List.Sum(List.FirstN(#"Added Is_New_Session"[Is_New_Session], [Index] + 1))</code></pre>
                    </div>
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl mt-4" start="2">
                        <li>This creates a unique session number that increments each time <strong>Is_New_Session = 1</strong>.</li>
                        <li>Optional: Concatenate with User_ID for globally unique sessions: <code class="text-xs bg-gray-100 px-2 py-1 rounded">[User_ID] & "_" & Text.From([Session_ID])</code></li>
                    </ul>
                </div>
            </section>

            <!-- Step 6 -->
            <section id="step6" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">6</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Add Event Index per Session</h2>
                        <p class="mt-2 text-gray-700">Number events within each session (1st page, 2nd page, etc.) to identify entry and exit pages.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Group by <strong class="font-semibold text-gray-800">Session_ID</strong>.</li>
                        <li>Click <strong class="font-semibold text-gray-800">Add Column > Index Column > From 1</strong> within each group.</li>
                        <li>Name it <strong class="font-semibold text-gray-800">Event_Number</strong>.</li>
                        <li>This lets you identify:
                            <ul class="list-disc list-inside ml-6 mt-2">
                                <li>Entry page (Event_Number = 1)</li>
                                <li>Exit page (Event_Number = MAX for that session)</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </section>

            <!-- Step 7 -->
            <section id="step7" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">7</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Aggregate to Session Level</h2>
                        <p class="mt-2 text-gray-700">Roll up events into session-level metrics: start time, end time, page count, duration.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Click <strong class="font-semibold text-gray-800">Group By</strong> (Transform tab).</li>
                        <li>Group by <strong class="font-semibold text-gray-800">Session_ID</strong> and <strong class="font-semibold text-gray-800">User_ID</strong>.</li>
                        <li>Add these aggregations:</li>
                    </ul>
                    <div class="bg-white rounded border p-4 mt-3 max-w-2xl text-xs">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2 text-left border">New Column</th>
                                    <th class="p-2 text-left border">Operation</th>
                                    <th class="p-2 text-left border">Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="p-2 border">Session_Start</td><td class="p-2 border">Min</td><td class="p-2 border">Event_Timestamp</td></tr>
                                <tr><td class="p-2 border">Session_End</td><td class="p-2 border">Max</td><td class="p-2 border">Event_Timestamp</td></tr>
                                <tr><td class="p-2 border">Page_Count</td><td class="p-2 border">Count Rows</td><td class="p-2 border">-</td></tr>
                                <tr><td class="p-2 border">All_Rows</td><td class="p-2 border">All Rows</td><td class="p-2 border">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl mt-4" start="4">
                        <li>Add a custom column for <strong class="font-semibold text-gray-800">Time_On_Session</strong> (in minutes):</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>Duration.TotalMinutes([Session_End] - [Session_Start])</code></pre>
                    </div>
                </div>
            </section>

            <!-- Step 8 -->
            <section id="step8" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">8</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Add Conversion Flags</h2>
                        <p class="mt-2 text-gray-700">Mark sessions where a conversion event occurred (e.g., visited /checkout or /thank-you).</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Expand the <strong class="font-semibold text-gray-800">All_Rows</strong> column to access individual event details.</li>
                        <li>Add a custom column <strong class="font-semibold text-gray-800">Has_Conversion</strong>:</li>
                    </ul>
                    <div class="bg-gray-900 text-gray-100 p-4 rounded-lg mt-3 max-w-3xl overflow-x-auto">
                        <pre class="text-sm"><code>List.Contains([All_Rows][Page_URL], "/thank-you")</code></pre>
                    </div>
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl mt-4" start="3">
                        <li>This returns <strong>true</strong> if any event in the session visited the conversion page.</li>
                        <li>Remove the <strong>All_Rows</strong> column to clean up your table.</li>
                    </ul>
                </div>
            </section>

            <!-- Step 9 -->
            <section id="step9" class="step-card rounded-xl p-6 sm:p-8">
                <div class="flex items-start gap-4">
                    <div class="step-number w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-lg">9</div>
                    <div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Analyze Session Funnel</h2>
                        <p class="mt-2 text-gray-700">Load your sessionized data and build conversion funnel reports.</p>
                    </div>
                </div>
                <div class="mt-6">
                    <ul class="list-decimal list-inside space-y-2 text-gray-600 max-w-3xl">
                        <li>Click <strong class="font-semibold text-gray-800">Close & Load</strong>.</li>
                        <li>Now you can analyze:
                            <ul class="list-disc list-inside ml-6 mt-2 space-y-1">
                                <li>Conversion rate = Sessions with conversion / Total sessions</li>
                                <li>Average pages per session by conversion status</li>
                                <li>Average time on session for converters vs. non-converters</li>
                                <li>Entry page performance (conversion rate by landing page)</li>
                            </ul>
                        </li>
                    </ul>
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 my-6 max-w-3xl">
                        <p><strong class="font-semibold text-green-800">Success!</strong> You've turned messy event logs into meaningful sessions with actionable metrics. This pattern works for any time-series events: app usage, sensor data, API calls.</p>
                    </div>
                </div>
            </section>

            <!-- Bonus Section -->
            <section id="bonus" class="step-card rounded-xl p-6 sm:p-8 bg-indigo-50 border-indigo-200">
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-900 mb-4">🚀 Advanced: Funnel Step Analysis</h2>
                <div class="space-y-3 text-gray-700">
                    <p>Track specific funnel steps (Home → Product → Cart → Checkout):</p>
                    <ul class="list-disc list-inside ml-4 space-y-2 text-sm">
                        <li>Create boolean columns for each step (e.g., <code class="text-xs bg-gray-100 px-2 py-1 rounded">Visited_Product</code>)</li>
                        <li>Aggregate these at session level to see which steps were completed</li>
                        <li>Calculate drop-off rates between each consecutive step</li>
                        <li>Identify where most users abandon the funnel</li>
                    </ul>
                </div>
            </section>

        </div>
    </div>
</main>
<script>
/**
 * Initializes the interactive diagrams for the 'Sessionize Web Analytics Funnel' guide.
 * Sets up event listeners for the event timeline visualizer and session grouping demo.
 */
window.init_web_sessionization = function() {
    
    /**
     * --- Diagram 1: Event Timeline Visualizer ---
     * Shows events on a timeline and highlights session boundaries based on timeout
     */
    const d1_timeout = document.getElementById('d1-timeout');
    if (d1_timeout) {
        const d1 = {
            timeout: d1_timeout,
            timeoutValue: document.getElementById('d1-timeout-value'),
            timeline: document.getElementById('d1-timeline'),
            message: document.getElementById('d1-message'),
        };

        const events = [
            { user: 'user_123', time: '09:00', page: '/home', minutes: 0 },
            { user: 'user_123', time: '09:02', page: '/products', minutes: 2 },
            { user: 'user_123', time: '09:05', page: '/checkout', minutes: 3 },
            { user: 'user_123', time: '12:00', page: '/home', minutes: 175 },
            { user: 'user_123', time: '12:03', page: '/about', minutes: 3 },
        ];

        function renderTimeline(timeout) {
            let html = '<div class="space-y-3">';
            let sessionNum = 1;
            let prevMinutes = 0;

            events.forEach((event, idx) => {
                const isNewSession = idx === 0 || event.minutes > timeout;
                if (isNewSession && idx > 0) {
                    sessionNum++;
                    html += '<div class="border-t-2 border-dashed border-red-400 my-2"></div>';
                    html += '<div class="text-xs text-red-600 font-semibold mb-2">↑ New Session (timeout exceeded)</div>';
                }

                const sessionColor = sessionNum === 1 ? 'bg-blue-100 border-blue-400' : 
                                   sessionNum === 2 ? 'bg-green-100 border-green-400' : 
                                   'bg-purple-100 border-purple-400';

                html += `
                    <div class="flex items-center gap-3 p-2 rounded border ${sessionColor}">
                        <div class="text-xs font-semibold text-gray-600 w-16">${event.time}</div>
                        <div class="text-xs flex-1">${event.page}</div>
                        <div class="text-xs text-gray-500">${idx > 0 ? `+${event.minutes} min` : 'Start'}</div>
                        <div class="text-xs font-semibold px-2 py-1 rounded ${sessionColor}">S${sessionNum}</div>
                    </div>
                `;
            });

            html += '</div>';
            d1.timeline.innerHTML = html;
        }

        d1.timeout.addEventListener('input', () => {
            const timeout = parseInt(d1.timeout.value);
            d1.timeoutValue.textContent = `${timeout} min`;
            renderTimeline(timeout);
            d1.message.textContent = `Session timeout set to ${timeout} minutes`;
            setTimeout(() => { d1.message.textContent = ''; }, 2000);
        });

        // Initial render
        renderTimeline(30);
    }

    /**
     * --- Diagram 2: Session Grouping Demo ---
     * Shows how events are grouped into sessions
     */
    const d2_groupBtn = document.getElementById('d2-group-btn');
    if (d2_groupBtn) {
        const d2 = {
            groupBtn: d2_groupBtn,
            events: document.getElementById('d2-events'),
            sessions: document.getElementById('d2-sessions'),
            message: document.getElementById('d2-message'),
        };

        const sampleEvents = [
            { user: 'user_456', time: '10:00', page: '/home' },
            { user: 'user_456', time: '10:05', page: '/products' },
            { user: 'user_456', time: '10:08', page: '/cart' },
            { user: 'user_789', time: '10:15', page: '/home' },
            { user: 'user_789', time: '10:20', page: '/blog' },
            { user: 'user_456', time: '11:00', page: '/home' },
        ];

        // Display initial events
        let eventsHtml = '<div class="font-semibold text-gray-700 mb-2">Raw Events:</div>';
        sampleEvents.forEach(event => {
            eventsHtml += `
                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border">
                    <div class="text-xs w-20">${event.user}</div>
                    <div class="text-xs w-16">${event.time}</div>
                    <div class="text-xs flex-1">${event.page}</div>
                </div>
            `;
        });
        d2.events.innerHTML = eventsHtml;

        d2.groupBtn.addEventListener('click', () => {
            d2.groupBtn.classList.add('opacity-50');
            d2.groupBtn.disabled = true;
            
            // Group events into sessions
            const sessions = [];
            let currentSession = null;

            sampleEvents.forEach((event, idx) => {
                const prevEvent = idx > 0 ? sampleEvents[idx - 1] : null;
                const isNewSession = !prevEvent || 
                                    event.user !== prevEvent.user || 
                                    (parseInt(event.time.split(':')[0]) - parseInt(prevEvent.time.split(':')[0])) > 0.5;

                if (isNewSession) {
                    if (currentSession) sessions.push(currentSession);
                    currentSession = {
                        id: sessions.length + 1,
                        user: event.user,
                        start: event.time,
                        end: event.time,
                        pages: [event.page],
                    };
                } else {
                    currentSession.end = event.time;
                    currentSession.pages.push(event.page);
                }
            });
            if (currentSession) sessions.push(currentSession);

            // Display sessions
            let sessionsHtml = '<div class="font-semibold text-gray-700 mb-2">Grouped Sessions:</div>';
            sessions.forEach((session, idx) => {
                const color = idx % 2 === 0 ? 'bg-blue-50 border-blue-400' : 'bg-green-50 border-green-400';
                sessionsHtml += `
                    <div class="p-3 rounded border-2 ${color}">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-semibold text-sm">Session ${session.id}</div>
                            <div class="text-xs text-gray-600">${session.user}</div>
                        </div>
                        <div class="text-xs space-y-1">
                            <div>⏱️ ${session.start} - ${session.end}</div>
                            <div>📄 ${session.pages.length} page(s): ${session.pages.join(' → ')}</div>
                        </div>
                    </div>
                `;
            });

            d2.sessions.innerHTML = sessionsHtml;
            d2.sessions.classList.remove('hidden');
            d2.events.classList.add('hidden');
            d2.message.textContent = `✓ Grouped into ${sessions.length} sessions!`;
            d2.message.classList.add('text-green-600');
        });
    }
};
</script>

